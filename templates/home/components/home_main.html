{% load static %}


<h2 class="mt-5">CodeOnion's Licenses Hunter</h2>
{% if not validRepo  %}
<p> {{scope_message}}</p>
<p> {{url_instructons_message}}</p>
{% endif %}
{% if not repo_name  %}
<div id="form-head"  class="">
<form method="POST" action="">
    {% csrf_token %}
    <div class="input-group mb-3">
        <input id="input" type="text" name="repository" class="form-control" placeholder="https://github.com/user/repo"  aria-describedby="button-addon2">
        <button disabled class="btn btn-outline-secondary text-white" type="submit" id="button-addon2">Scan!</button>
      </div>

    <!-- <input type="text" name="repository" class="form-control" placeholder="repo to scan">
    <button type="submit" class="btn btn-outline-info" aria-label="Left Align">
        Scan!
     </button> -->
</form>

</div>
{% endif %}

{% if validRepo  %}


<a id="new_scan_btn" class="btn custom-button btn-outline-warning text-center mt-5 visually-hidden" href="/">New Scan</a>
<h3 id="header3" class="mt-5">Showing results for <span><a class="text-decoration-none" target="_blank" href="{{url}}">{{repo_name}}</a></span> repository </h3>
<!-- <h3 class="mt-5">Showing results for <span><a class="text-decoration-none" href="{{url}}">{{url}}</a></span>  </h3> -->

<p id="total"></p>

{% endif %}


<div id="spinner" class="visually-hidden">
    
    <h4 class="mb-2">Please hold on we are going through the files...</h4>
    <div class="" id="timer"></div>
    <div class="loader">
        <div class="inner one"></div>
        <div class="inner two"></div>
        <div class="inner three"></div>
      </div>
      
</div>

<button class="visually-hidden btn btn-outline-danger btn-sm" id="pdf">Download PDF</button>
<div id="response_table">
    
</div>

<div id="scan_status">
   
</div>

{% if repo_name  %}
<a class="btn custom-button btn-outline-warning text-center mt-5" href="/">New Scan</a>
{% endif %}

<script type="text/javascript">
    // let's set up some variables
    
    let repo_name = "{{repo_name}}"
    console.log(repo_name)
    let repo_id = "{{repo_uuid}}"; // the object that we'll be looking for in the APIs
    let repo_scan_started = "{{repo_scan_started}}";  // If the scan is started, go to long polling api to check when completed. 
    let repo_scan_completed = "{{repo_scan_completed}}";  // If the scan is completed, go to collecting the results
    let scan_id = "{{scan_response_id}}"
    let root_url = window.location.href
    if (root_url.slice(-1)==='/'){
        scan_api_url = window.location.href + `scan_status/${scan_id}`
        result_api_url = window.location.href + `repo_dependencies/${repo_id}`
    }
    else {
        scan_api_url = window.location.href + `/scan_status/${scan_id}`
        result_api_url = window.location.href + `/repo_dependencies/${repo_id}`
    }
    // console.log(root_url)
    // console.log(scan_api_url)
    // console.log(result_api_url)
    let loop_counter = 0
    let continue_marker = 'not'

    async function subscribe(loop_counter) {
        response = await fetch(scan_api_url)
        json = await response.json()
        // console.log(json.status)
        // console.log(loop_counter)
        if ((json.status == 'complete') || (loop_counter > 30 )) 
            return json.status
        else {
            document.getElementById("scan_status").innerHTML = 'Scanning the repo for ' + loop_counter + ' seconds';
            await new Promise(resolve => setTimeout(resolve, 1000));
            loop_counter += 1
            await subscribe(loop_counter);
        }
    }

    async function render() {
        // console.log('starting_render')
        response = await fetch(result_api_url)
        a = await response.json()
        // console.log(a)
        let scan_status = a.status;
        // console.log(a.status)
        if (scan_status == 'true') {
            var count = Object.keys(a.results).length;
            document.getElementById("total").innerHTML = `Found total dependencies: ${count}`
            if(count > 0){
                document.getElementById('new_scan_btn').classList.remove('visually-hidden')
                document.getElementById('pdf').classList.remove('visually-hidden')

                var tableHeader = "<table id=\"table\" class=\"table table-borderless mt-5 text-white text-start\"><thead><tr><th>Dependency Name</th><th>Dependency Language</th><th>Dependency License</th></tr></thead><tbody>"
                var tableContent = "";
                var tableFooter = "</tbody></table>";

                // Loop through the JSON and output each row in to a string.
                for(i = 0; i < count; i++) {
                    tableContent = tableContent + "<tr><td>" + a.results[i].dependency_name + "</td><td>" + a.results[i].dependency_language + "</td><td>" + a.results[i].dependency_license + "</td></tr>";
                    }
                // return the table
                document.getElementById("response_table").innerHTML = tableHeader + tableContent + tableFooter;
           }else{
            document.getElementById("response_table").innerHTML = "<p>Unfortunately your requirements file doesn't have the standard seperators and our product can't read them properly</p>"  

           }
        }
        else {
            // get the error message
            var results = a.results;
            // render the error message
            document.getElementById("response_table").innerHTML = results;
            };
        }


       async function run() {
           // console.log('starting run',repo_scan_started)
           if ((repo_scan_started == 'True') && (scan_id != 'None')) {
                // console.log(repo_scan_started)
                continue_marker = await subscribe(loop_counter)
                // console.log(continue_marker)
           }
           if (repo_scan_started == 'True') {
            render()
            }
        }


        run()
    //run(repo_scan_started)
    
    let spinner = document.getElementById('spinner');
    let form = document.getElementById('form-head');
    let searchButton = document.getElementById('button-addon2');
    let input = document.getElementById('input');
    
    //disable button if its empty
    if(input){
    input.addEventListener("input", function(e) {
	if(input.value.length != 0 ) {
        searchButton.disabled = false
      } 
     })
    }
    // onclick hide the form and show spinner
    if(searchButton){
    searchButton.addEventListener('click',function(e){
    spinner.classList.remove('visually-hidden');
    form.classList.add('visually-hidden');
    totalSeconds = 0;
    countTimer()
     })
   }
   // generate pdf
   let pdfButton = document.getElementById("pdf");
   if(pdfButton){
    pdfButton.onclick= function(){
       
       let results = document.getElementById("response_table");

       document.getElementById("table").classList.add('bg-dark');

       let opt = {
         margin: 1,
         filename: `${repo_name}_dependencies.pdf`,
         image: { type: 'jpeg', quality: 0.98 },
         html2canvas: { scale: 2 },
         jsPDF:  { unit: 'in', format:'letter', orientation: 'portrait'}
       };
       html2pdf(results, opt)
      }
   }


   var timerVar = setInterval(countTimer, 1000);
   var totalSeconds = 0;
   function countTimer() {
           ++totalSeconds;
           var hour = Math.floor(totalSeconds /3600);
           var minute = Math.floor((totalSeconds - hour*3600)/60);
           var seconds = totalSeconds - (hour*3600 + minute*60);
           if(hour < 10)
             hour = "0"+hour;
           if(minute < 10)
             minute = "0"+minute;
           if(seconds < 10)
             seconds = "0"+seconds;
           document.getElementById("timer").innerHTML ='Scanning the repo for '+  minute + ":" + seconds + ' seconds';
        }

// the test code for the poll until condition is met
    // this is just a placeholder. It will eventually be a function that evaluates.


</script>